<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Payout Calculator - Torn Tools</title>
    <link rel="stylesheet" href="../styles/styles.css">
</head>
<body>
    <div class="container">
        <h1>War Payout Calculator</h1>
        <p class="description">Calculate and distribute war payouts with advanced options and member statistics.</p>
        
        <!-- Faction ID Input (Hidden - auto-filled) -->
        <div class="input-section" style="display: none;">
            <label for="factionId">Faction ID:</label>
            <input type="text" id="factionId" placeholder="Will auto-fill from your API key">
        </div>

        <!-- War Selection -->
        <div class="input-section" style="margin-bottom: 20px;">
            <!-- Instruction Message (shown when no API key) -->
            <div id="apiKeyInstructionMessage" style="padding: 15px; background-color: #2a2a2a; border-left: 4px solid #4CAF50; border-radius: 4px; margin-bottom: 15px;">
                <p style="margin: 0; color: #e0e0e0; font-size: 14px;">
                    <strong>ðŸ‘‹ Welcome!</strong> Please enter your Torn API key in the sidebar to get started.
                </p>
                <p style="margin: 5px 0 0 0; color: #b0b0b0; font-size: 13px;">
                    Your wars will load automatically once your API key is entered.
                </p>
            </div>
            
            <div id="warSelectorContainer" style="display: none; margin-bottom: 0;">
                <label for="warSelector" style="display: inline-block;">Select War:</label>
                <select id="warSelector" style="margin-top: 6px; margin-bottom: 10px;">
                    <option value="">Choose a war...</option>
                </select>
                <div id="fetchDataContainer" style="display: none;">
                    <button id="fetchData" class="btn btn-success" type="button">Fetch War Data</button>
                    <span id="loadingWarData" class="loading-text" style="display: none; margin-top: 8px;">Fetching war data<span class="loading-dots">...</span></span>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>Fetching war data...</p>
        </div>
        
        <!-- Progress Bar -->
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div class="progress-info">
                <span id="progressMessage">Fetching war data...</span>
                <span id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div class="progress-details">
                <span id="progressDetails">Initializing...</span>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tab-buttons" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="tab-button active" data-tab="war-report-tab" type="button">War Report</button>
                <button class="tab-button" data-tab="payout-tab" type="button">War Payout Calculator<br><span style='font-size:0.95em;'>(Hit Based)</span></button>
                <button class="tab-button" data-tab="respect-payout-tab" type="button">War Payout Calculator<br><span style='font-size:0.95em;'>(Respect Based)</span></button>
            </div>

            <!-- War Report Tab -->
            <div class="tab-pane active" id="war-report-tab">
                <div class="summary-box">
                    <div id="warSummary"></div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Member Statistics</h3>
                        <button id="exportCSV" class="btn btn-secondary" type="button">Export to CSV</button>
                    </div>
                    <div id="membersTable"></div>
                </div>
            </div>

            <!-- War Payout Calculator Tab -->
            <div class="tab-pane" id="payout-tab" style="display: none;">
                <div class="payout-inputs" style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 5px;">
                    <h3 class="summary-header">War Payout Summary</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;">
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label for="cacheSales">Cache Sales:</label>
                                                                    <div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="cacheSales" value="1000000000" placeholder="e.g., 1b, 500m, 100k" style="width: 100%; padding: 8px; margin-top: 5px;"></div>
                                <div style="margin-top: 10px;">
                                    <strong style="color: #fff; font-weight: normal; font-size: 1em;">Other Costs:</strong>
                                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; margin-top: 5px; align-items: center;">
                                                                                     <label>Consumables:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="otherConsumables" value="150000000" placeholder="e.g., 150m" style="width: 120px;"></div>
                                             <label>Spies:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="otherSpies" value="0" placeholder="e.g., 50m" style="width: 120px;"></div>
                                             <label>Bounties:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="otherBounties" value="0" placeholder="e.g., 25m" style="width: 120px;"></div>
                                             <label>Terms:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="otherTerms" value="0" placeholder="e.g., 10m" style="width: 120px;"></div>
                                             <label>Other:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="otherOther" value="0" placeholder="e.g., 5m" style="width: 120px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <label for="payPerHit">Pay Per War Hit (PPWH):</label>
                                                                    <div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="payPerHit" value="1000000" placeholder="e.g., 1m, 500k, 100k" style="width: 100%; padding: 8px; margin-top: 5px;"></div>
                                <h3 style="color: #fff; font-weight: normal; font-size: 1em; margin: 18px 0 8px 0;">Advanced Payout Options:</h3>
                                <div style="margin-top: 15px; display: grid; grid-template-columns: 1.5fr 1fr; gap: 8px 12px; align-items: center;">
                                    <label style="display: flex; align-items: center;" title="Pay for assist attacks"><input type="checkbox" id="payAssists" checked style="accent-color: #ffd700; margin-right: 8px;"> Pay Assists</label>
                                    <span style="justify-self: end; text-align: right;">Multiplier: <input type="number" id="assistMultiplier" value="0.25" min="0" step="0.01" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <label style="display: flex; align-items: center;" title="Pay for retaliation attacks"><input type="checkbox" id="payRetals" checked style="accent-color: #ffd700; margin-right: 8px;"> Pay Retals</label>
                                    <span style="justify-self: end; text-align: right;">Multiplier: <input type="number" id="retalMultiplier" value="0.5" min="0" step="0.01" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <label style="display: flex; align-items: center;" title="Pay for overseas attacks"><input type="checkbox" id="payOverseas" checked style="accent-color: #ffd700; margin-right: 8px;"> Pay Overseas</label>
                                    <span style="justify-self: end; text-align: right;">Multiplier: <input type="number" id="overseasMultiplier" value="0.25" min="0" step="0.01" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <label style="display: flex; align-items: center;" title="Pay for non-war attacks"><input type="checkbox" id="payOtherAttacks" checked style="accent-color: #ffd700; margin-right: 8px;"> Pay Other Attacks</label>
                                    <span style="justify-self: end; text-align: right;">Multiplier: <input type="number" id="otherAttacksMultiplier" value="0.1" min="0" step="0.01" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>


                                    <label style="grid-column: 1 / span 1; display: flex; align-items: center; color: #ffd700;" title="Filter low FF hits - paid at 'Other Attacks' rate. Retaliations always count as good hits.">
                                        <input type="checkbox" id="filterLowFF" style="accent-color: #ffd700; margin-right: 8px;">
                                        Filter Low Fair Fight Hits
                                    </label>
                                    <span style="justify-self: end; text-align: right;">Min FF: <input type="number" id="minFFRating" value="2.0" min="0" step="0.1" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>
                                </div>

                                <!-- Hit Threshold Controls -->
                                <div style="grid-column: 1 / span 2; margin-top: 15px; padding: 15px; background-color: #1a1a1a; border-radius: 6px; border-left: 3px solid #ffd700;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            <label style="display: flex; align-items: center; color: #ffd700; font-weight: bold;">
                                                <input type="checkbox" id="hitEnableThresholds" style="accent-color: #ffd700; margin-right: 8px;">
                                                Enable Hit Thresholds
                                            </label>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <label style="color: #ccc; font-size: 0.9em;">Min Hits:</label>
                                                <input type="number" id="hitMinThreshold" value="20" min="0" step="1" style="width: 80px; padding: 4px; background-color: #2a2a2a; border: 1px solid #404040; color: #fff; border-radius: 3px;">
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <label id="hitMaxThresholdLabel" style="color: #ccc; font-size: 0.9em;">Max Hits:</label>
                                                <input type="number" id="hitMaxThreshold" value="50" min="0" step="1" style="width: 80px; padding: 4px; background-color: #2a2a2a; border: 1px solid #404040; color: #fff; border-radius: 3px;">
                                            </div>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            <label style="color: #ffd700; font-weight: bold; margin-bottom: 5px;">Payout Mode:</label>
                                            <label style="display: flex; align-items: center; color: #ccc; cursor: pointer;">
                                                <input type="radio" name="hitPayoutMode" value="ratio" checked style="accent-color: #ffd700; margin-right: 6px;">
                                                Ratio Based (proportional within range)
                                            </label>
                                            <label style="display: flex; align-items: center; color: #ccc; cursor: pointer;">
                                                <input type="radio" name="hitPayoutMode" value="equal" style="accent-color: #ffd700; margin-right: 6px;">
                                                Equal Payout (same amount for all in range)
                                            </label>
                                        </div>
                                    </div>
                                    <!-- Explanation text at bottom of card -->
                                    <div style="padding-top: 10px; border-top: 1px solid #404040;">
                                        <div style="font-size: 0.8em; color: #999; line-height: 1.4;">
                                            <div>â€¢ <strong>Ratio:</strong> Pay Per War Hit Ã— adjusted hits (capped at max threshold)</div>
                                            <div>â€¢ <strong>Equal:</strong> Pay Per War Hit Ã— minimum threshold (ignores max threshold)</div>
                                            <div>â€¢ <strong>Other modifiers:</strong> Capped at minimum threshold payout when below threshold</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <div id="payoutTable"></div>
                </div>
            </div>

            <!-- Respect Based War Payout Calculator Tab -->
            <div class="tab-pane" id="respect-payout-tab" style="display: none;">
                <div class="payout-inputs" style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 5px;">
                    <h3 class="summary-header">Respect Based War Payout Summary</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;">
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label for="respectCacheSales">Cache Sales:</label>
                                                                    <div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="respectCacheSales" value="1000000000" placeholder="e.g., 1b, 500m, 100k" style="width: 100%; padding: 8px; margin-top: 5px;"></div>
                                <div style="margin-top: 10px;">
                                    <label for="respectRemainingPercentage">Remaining Percentage:</label>
                                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                                        <input type="number" id="respectRemainingPercentage" min="0" max="50" value="30" style="width: 80px; padding: 8px;">
                                        <span style="color: #fff; font-weight: normal;">%</span>
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <strong style="color: #fff; font-weight: normal; font-size: 1em;">Other Costs:</strong>
                                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; margin-top: 5px; align-items: center;">
                                                                                     <label>Consumables:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="respectOtherConsumables" value="150000000" placeholder="e.g., 150m" style="width: 120px;"></div>
                                             <label>Spies:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="respectOtherSpies" value="0" placeholder="e.g., 50m" style="width: 120px;"></div>
                                             <label>Bounties:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="respectOtherBounties" value="0" placeholder="e.g., 25m" style="width: 120px;"></div>
                                             <label>Terms:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="respectOtherTerms" value="0" placeholder="e.g., 10m" style="width: 120px;"></div>
                                             <label>Other:</label><div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="respectOtherOther" value="0" placeholder="e.g., 5m" style="width: 120px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <label for="respectPayPerHit">Pay Per War Hit (Auto-calculated):</label>
                                                                    <div style="display: flex; align-items: center;"><span style="color: #fff; font-weight: normal; margin-right: 4px; display: flex; align-items: center;">$</span><input type="text" id="respectPayPerHit" value="0" style="width: 100%; padding: 8px; margin-top: 5px;" readonly></div>
                                <h3 style="color: #fff; font-weight: normal; font-size: 1em; margin: 18px 0 8px 0;">Advanced Payout Options:</h3>
                                <div style="margin-top: 15px; display: grid; grid-template-columns: 1.5fr 1fr; gap: 8px 12px; align-items: center;">
                                    <label style="display: flex; align-items: center;" title="Pay for assist attacks"><input type="checkbox" id="respectPayAssists" checked style="accent-color: #ffd700; margin-right: 8px;"> Pay Assists</label>
                                    <span style="justify-self: end; text-align: right;">Multiplier: <input type="number" id="respectAssistMultiplier" value="0.25" min="0" step="0.01" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <label style="display: flex; align-items: center;" title="Pay for retaliation attacks">
                                        <input type="checkbox" id="respectPayRetals" style="accent-color: #ffd700; margin-right: 8px;"> 
                                        Pay Retals
                                        <button type="button" class="chain-link-btn" data-option="respectPayRetals" style="background: none; border: none; color: #ffd700; cursor: pointer; margin-left: 8px; font-size: 14px; padding: 2px;" title="Click to unlink this option">ðŸ”—</button>
                                    </label>
                                    <span style="justify-self: end; text-align: right;">Multiplier: <input type="number" id="respectRetalMultiplier" value="0.5" min="0" step="0.01" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <label style="display: flex; align-items: center;" title="Pay for overseas attacks">
                                        <input type="checkbox" id="respectPayOverseas" style="accent-color: #ffd700; margin-right: 8px;"> 
                                        Pay Overseas
                                        <button type="button" class="chain-link-btn" data-option="respectPayOverseas" style="background: none; border: none; color: #ffd700; cursor: pointer; margin-left: 8px; font-size: 14px; padding: 2px;" title="Click to unlink this option">ðŸ”—</button>
                                    </label>
                                    <span style="justify-self: end; text-align: right;">Multiplier: <input type="number" id="respectOverseasMultiplier" value="0.25" min="0" step="0.01" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <label style="display: flex; align-items: center;" title="Pay for non-war attacks"><input type="checkbox" id="respectPayOtherAttacks" checked style="accent-color: #ffd700; margin-right: 8px;"> Pay Other Attacks</label>
                                    <span style="justify-self: end; text-align: right;">Multiplier: <input type="number" id="respectOtherAttacksMultiplier" value="0.1" min="0" step="0.01" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <label style="grid-column: 1 / span 1; display: flex; align-items: center; color: #ffd700;" title="Require minimum war hits + assists to qualify">
                                        <input type="checkbox" id="respectEnableCombinedMin" checked style="accent-color: #ffd700; margin-right: 8px;">
                                        Combined War Hits + Assists
                                    </label>
                                    <span style="justify-self: end; text-align: right;">Min: <input type="number" id="respectCombinedMin" value="20" min="0" step="1" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <label style="grid-column: 1 / span 1; display: flex; align-items: center; color: #ffd700;" title="Remove chain & group bonuses from respect calculations">
                                        <input type="checkbox" id="respectRemoveModifiers" style="accent-color: #ffd700; margin-right: 8px;">
                                        Remove Assist and Chain Modifiers
                                        <button type="button" class="chain-link-btn" data-option="respectRemoveModifiers" style="background: none; border: none; color: #ffd700; cursor: pointer; margin-left: 8px; font-size: 14px; padding: 2px;" title="Click to unlink this option">ðŸ”—</button>
                                    </label>
                                    <span style="justify-self: end; text-align: right; color: #ccc; font-size: 0.9em;"></span>

                                    <label style="grid-column: 1 / span 1; display: flex; align-items: center; color: #ffd700;" title="Include outside respect (non-war hits) in payout calculations">
                                        <input type="checkbox" id="respectIncludeOutside" style="accent-color: #ffd700; margin-right: 8px;">
                                        Include Outside Respect
                                    </label>
                                    <span style="justify-self: end; text-align: right; color: #ccc; font-size: 0.9em;"></span>

                                    <label style="grid-column: 1 / span 1; display: flex; align-items: center; color: #ffd700;" title="Filter low FF hits - excluded from respect, paid at 'Other Attacks' rate. Retaliations always count as good hits.">
                                        <input type="checkbox" id="respectFilterLowFF" style="accent-color: #ffd700; margin-right: 8px;">
                                        Filter Low Fair Fight Hits
                                    </label>
                                    <span style="justify-self: end; text-align: right;">Min FF: <input type="number" id="respectMinFFRating" value="2.0" min="0" step="0.1" style="width: 60px; text-align: right; -moz-appearance: textfield; -webkit-appearance: textfield; appearance: textfield;"> </span>

                                    <!-- Respect Threshold Controls -->
                                    <div style="grid-column: 1 / span 2; margin-top: 15px; padding: 15px; background-color: #1a1a1a; border-radius: 6px; border-left: 3px solid #ffd700;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                <label style="display: flex; align-items: center; color: #ffd700; font-weight: bold;">
                                                    <input type="checkbox" id="respectEnableThresholds" style="accent-color: #ffd700; margin-right: 8px;">
                                                    Enable Respect Thresholds
                                                </label>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <label style="color: #ccc; font-size: 0.9em;">Min Respect:</label>
                                                    <input type="number" id="respectMinThreshold" value="100" min="0" step="1" style="width: 80px; padding: 4px; background-color: #2a2a2a; border: 1px solid #404040; color: #fff; border-radius: 3px;">
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <label style="color: #ccc; font-size: 0.9em;">Max Respect:</label>
                                                    <input type="number" id="respectMaxThreshold" value="300" min="0" step="1" style="width: 80px; padding: 4px; background-color: #2a2a2a; border: 1px solid #404040; color: #fff; border-radius: 3px;">
                                                </div>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                <label style="color: #ffd700; font-weight: bold; margin-bottom: 5px;">Payout Mode:</label>
                                                <label style="display: flex; align-items: center; color: #ccc; cursor: pointer;">
                                                    <input type="radio" name="respectPayoutMode" value="ratio" checked style="accent-color: #ffd700; margin-right: 6px;">
                                                    Ratio Based (proportional within range)
                                                </label>
                                                <label style="display: flex; align-items: center; color: #ccc; cursor: pointer;">
                                                    <input type="radio" name="respectPayoutMode" value="equal" style="accent-color: #ffd700; margin-right: 6px;">
                                                    Equal Payout (same amount for all in range)
                                                </label>
                                            </div>
                                        </div>
                                        <!-- Explanation text at bottom of card -->
                                        <div style="padding-top: 10px; border-top: 1px solid #404040;">
                                            <div style="font-size: 0.8em; color: #999; line-height: 1.4;">
                                                <div>â€¢ <strong>Ratio:</strong> Pay proportional to respect within range</div>
                                                <div>â€¢ <strong>Equal:</strong> All players in range get same payout</div>
                                                <div>â€¢ <strong>Other modifiers:</strong> Capped at minimum threshold when thresholds enabled</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <div id="respectPayoutTable"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../tools/war-report-2.0/war-report.js?v=debug-events"></script>
</body>
</html> 